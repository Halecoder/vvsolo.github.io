Object.assign(String.prototype,{replaceInit:function(){return(this.trim()+"\n").replace(/\n\n+/g,"\n")},replaceEnd:function(){return this.replaceHooks(config.rEndFix).replaces(config.rEnd).replaceFinish()},replaceFinish:function(){var r="」』”’",t="「『“‘";return this.replace(/^[」』”’]/gm,function(e){return t.charAt(r.indexOf(e))}).replace(/(?!^)[「『“‘](?:。|[！？…—~]{1,3}|$)$/gm,function(e){return r.charAt(t.indexOf(e.charAt(0)))+e.slice(1)}).replace(/\n\n\n+/g,"\n\n").replace(/^\n+/,"").replace(/\n\n+$/,"\n")},replaceHooks:function(e){var t=this;return e.forEach(function(r){"find"in r?(Array.isArray(r.find)||(r.find=[r.find]),r.find.forEach(function(e){t=t.replace(e,function(e){return"skip"in r&&e.eachArrayRegTest(r.skip)||"pass"in r&&!e.find(r.pass)?e:e.replaceHook(r)})})):t=t.replaceHook(r)}),t},replaceHook:function(e,r){var t,n=this;for(t in e)switch(t){case"find":case"skip":case"pass":break;case"at":n=n.replaceAt(e.at);break;case"rp":n=n.replace(e.rp[0],e.rp[1]);break;case"rps":n=n.replaces(e.rps);break;case"mr":n=n.cleanSpace(e.mr);break;case"mu":n=n.matchLetterCase(e.mu,"u");break;case"ml":n=n.matchLetterCase(e.ml,"l");break;case"mf":n=n.matchLetterCase(e.mf,"f");break;case"lc":n=n.toLetterCase(e.lc)}return n},toLetterCase:function(e){switch(e){case"u":return this.toUpperCase();case"l":return this.toLowerCase();case"f":return this.charAt(0).toUpperCase()+this.toLowerCase().slice(1)}return this},matchLetterCase:function(e,r){return this.replace(e,function(e){return e.toLetterCase(r)})},replaceSpace:function(){return this.cleanSpace(config.hanSpace,/ +/g)},replaceSeparator:function(){return this.replaces(config.rSeparator)},replaceQuotes:function(){return this.replaces(config.rQuotes)},replaceCNQuotes:function(){return this.replaceQuotes().replaceAt(config.aQuotes,!0)},convertESQuotes:function(){return this.replaceAt(config.aQuotes)},convertCNQuotes:function(){return this.replaceAt(config.aQuotes,!0)},convertEnglish:function(){var n,e=this,c=config.rEng,a=c.Special.toLowerCase(),i=c.Unit.toLowerCase(),r=[];return e.replace(config.novelAuthor,function(e){r.push([e.trims().getReg("gi"),e])}),e=e.matchLetterCase(c.Alphabets,"f").replaceHooks(c.Char).replace(("\\b("+c.Special+")(\\d{1,4}[a-z]{0,6})?\\b").getReg("gi"),function(e,r,t){return n=("|"+a+"|").indexOf("|"+r.toLowerCase()+"|")+1,("|"+c.Special+"|").substr(n,r.length)+(t&&t.toUpperCase()||"")}).replace(("\\b(\\d[0-9。.]* ?)("+c.Unit+")\\b").getReg("gi"),function(e,r,t){return n=("|"+i+"|").indexOf("|"+t.toLowerCase()+"|")+1,r+("|"+c.Unit+"|").substr(n,t.length)}).replace(c.Overlap,function(e,r){return e.replace(r.getReg("gi"),r.toLetterCase("f"))}).replaceHooks(c.End),e=0<r.length?e.replaces(r):e},convertNumberLetter:function(){return this.replace(/([Ａ-Ｚ][ａ-ｚ]+)(?=[Ａ-Ｚ][ａ-ｚ]+)/g,"$1 ").replaceAt(config.sNumberLetter)},__prepChapterFullNumber:function(){return this.replace(config.regFullNumberTitle,function(e){return e.replaceAt(config.sNumber)})},convertFullNumberLetter:function(){return this.replaceAt(config.sNumberLetter,!0).__prepChapterFullNumber()},convertUnicode:function(){return this.replace(/(?:[＆&]#[xX]|\\[uU]?)[\da-fA-F]{4}[;；]?/g,function(e){return unescape("%u"+e.replace(/[^\da-fA-F]/g,""))}).replace(/\\[xX][\da-fA-F]{2}\b/g,function(e){return unescape("%u00"+e.slice(2))}).replace(/[＆&]#\d+[;；]/g,function(e){return String.fromCharCode(e.slice(2,-1))}).replace(/(?:[%％][\da-fA-F]{2})+/g,function(r){try{return decodeURIComponent(r.replace(/％/g,"%"))}catch(e){return r}})},convertHtmlEntity:function(){var r;return this.replace(config.rHtmlEntity.find,function(e){return r=e.replace(/[&＆;； ]/g,""),0<(r=config.rHtmlEntity.data[r]||config.rHtmlEntity[r.toLowerCase()]||0)?String.fromCharCode(r):e})},convertVariant:function(){return this.replaceAt(config.sVariants)},convertSerialNumber:function(){var r=config.sSerialNumber,t=r[1].split("|");return this.replace(("["+r[0]+"]").getReg(),function(e){return"（"+(t[r[0].indexOf(e)]||"")+"）"})},convertPunctuation:function(){return this.replaceHook(config.rPunctuation)},setAlign:function(e,r,t){var n=2*config.Linenum,c=this.trims(),a=c.len();return a<n&&("center"===t?c="　".repeat(~~((n-a)/4))+(a%4==0?" ":"")+c:"right"===t&&(c="　".repeat(~~((n-a)/2))+(a%2==0?"":" ")+c)),(e||"")+c+(r||"")},__prepChapter:function(e,r){var t,n=getChapters[e],e=regChapter[e],c="",n=("join"in n&&(c=n.join,e=e.join(c)),n.tpl.chapFlag("gm",c)),c="^[{$b.0}]?(?:{$zz})[{$b.1}]?(?:{$s}[{$b.0}]?{$e}[{$b.1}]?)?$".fmt(e).chapReg(),a="[{$b}]".chapReg("g"),i=/，|。|(?:完|完结|待续|未完|终)$/;return this.replace("({$zz}\\n{1,2})\\1+".fmt(n.str).chapReg(),"$1").replace(c,function(e){return(t=e.trim().replace(a," ")).find(i)?e:t}).replace(n.str.getReg(n.flag),r)},__chaSkip:function(e){return this.eachArrayRegTest(config.regSkipTitle[e||"t0"])},replaceTitle:function(c,a,i,p){c=c||"\n\n",a=a||"";function o(e,r){return 0===(e=e.replace(/  +/g," ").replace("^[{$sep}]+".chapReg(),"")).length?"":/^\d+$/.test(e)?e.replace(RegExp["$&"],function(e){return config.Divide+(20<~~e?e:"（"+s(e)+"）")}):(e=e.replace(/([^\d\.])[ ·—-]([上中下终終完]|[零一二三四五六七八九十百]{1,5})$/,"$1（$2）").replace(/^(?:[上中下终終完])$/,"（$&）").replace(" (?=[{$han}]{2,})".comReg("g"),"，").replace(" (?=[{$han}])".comReg("g"),"").replace(/【?注(\d{1,2})】?/g,"【注$1】").replace(/([^\w\.\-—·])(\d{1,2}\/\d{1,2})$/,"$1（$2）").replace(/([^\w\.\-—·])[ —-]?\b([012]?[0-9])$/,"$1（$2）").replace(/（\d{1,3}）$/,function(e){return s(e)}).replace(/[ ·]\b[IVXC]{1,6}\b$/i,function(e){return"（"+e.slice(1).toUpperCase()+"）"}),void 0===r?config.Divide+e:e)}var n,e=this,r=regChapter,u="{$n4}[{$c}]".chapReg(),s=function(e){return e.replaceAt(config.sNumber).replace(/\b\d\b/g,"0$&")};p&&(r.s=r.sn,r.es=r.e);return e=e.replace(/^[ 　]*/g,"").cleanSpace("^{$ts}".chapReg()).replaceArr(config.regListTitle,function(e){return e.replace(/\n$/,"").replace(/^/gm,"☠")+"\n"}).__prepChapter("t0",function(e,r){return r.setAlign(c,a,i)}).__prepChapter("t1",function(e,r,t){return t.find(/^[\!\?！？。]{1,3}$/)||e.__chaSkip("t0")||e.__chaSkip("t1")?e:(r.find(/番外|同人|里番|[外前后][传傳]/)&&t.find(/^之/)?r+t:r+o(t)).setAlign(c,a,i)}).__prepChapter("t2",function(e,r,t,n){return(n=n.trims()).find(/^(?:完|完结|待续|未完|终)$/)?"【"+r+"·"+n+"】":r.find(/^[\-\—]{2,4}/)||e.__chaSkip("t0")||e.__chaSkip("t2")||!p&&n.find(/^[！？。…]{1,3}$/)||!t&&!p&&n.find(/，/)||!r.find(/^第/)&&n.find(/[！？。…’”』」]{1,3}$/)?e:(r.find(u)||(r="第"+r.replace(/^第+| /g,"")),(s(r)+o(n)).setAlign(c,a,i))}).__prepChapter("t3",function(e,r,t){return e.__chaSkip("t0")?e:(s(r)+o(t,"no")).setAlign(c,a,i)}),"center"!==i&&"break"!==i&&(n=strChapter.crt,e=e.__prepChapter("t4",function(e,r,t,n){return c+"第"+t+r+o(n)+a}).__prepChapter("t5",function(e,r,t){return c+"第"+s(r)+n+o(t)+a}).__prepChapter("t6",function(e,r,t){return t=t.trims(),r=s(r),e.find(/。/)||t.find(/^[！？。]{1,3}$/)||e.__chaSkip("t0")||e.__chaSkip("t2")||t.find(r.find(/^\d+/)?/[！？。]$/:/[！？。…’”』」]$/)||e.cleanSpace().__chaSkip("t6")?e:c+"第"+r+n+o(t)+a})),e.replaceTitleError().replace(/^\u2620/gm,"")},replaceTitleError:function(){function e(e){return-1<(e=e.replace(/\n+/g,"\n").split("\n",2))[1].search(/[。！？…～]$/)?e[0]+"\n"+e[1].replace(e[0],""):e[0].length>e[1].length?e[0]:e[1]}var r="^({$t91}[{$c.2}]{$sn})(?:{$e}|$)$\\n+\\1.*$".chapReg("gm"),t="^{$t3}(?:{$e}|$)$\\n+\\1.*$".chapReg("gm");return this.replace(r,e).replace(t,e)}});