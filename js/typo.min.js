Object.extend(String.prototype,{replaceInit:function(){return this.trim().replace(/$/,"\n").replace(/\n\n+/g,"\n")},replaceEnd:function(){return this.convertEngLine().__endFix().replaces(configs.rEnd).replaceFinish()},replaceFinish:function(){return this.replace(/^[\u300d\u300f\u201d\u2019]/gm,function(a){return"\u300c\u300e\u201c\u2018".charAt("\u300d\u300f\u201d\u2019".indexOf(a))}).replace(/[\u300c\u300e\u201c\u2018](?:\u3002|\uff01|\uff1f|\u2026\u2026|\u2014\u2014|~~|$)$/gm,function(a){return"\u300d\u300f\u201d\u2019".charAt("\u300c\u300e\u201c\u2018".indexOf(a.charAt(0)))+
a.slice(1)}).replace(/\n\n\n+/g,"\n\n").replace(/^\n+/,"").replace(/\n\n+$/,"\n")},__replaceFix:function(a){var b=this,e;for(e in a)switch(e){case "at":b=b.replaceAt(a.at);break;case "rp":b=b.replace(a.rp[0],a.rp[1]);break;case "rps":b=b.replaces(a.rps);break;case "upper":b=b.matchUpper(a.upper);break;case "lower":b=b.matchLower(a.lower);break;case "lc":switch(a.lc){case "u":b=b.toUpperCase();break;case "l":b=b.toLowerCase();break;case "f":b=b.toLowerCase().matchUpper(/\b[a-z]/g)}}return b},__endFix:function(){var a=
this;configs.rEndFix.each(function(b){a="find"in b?a.replace(b.find,function(e){return"skip"in b&&e.eachArrayRegTest(b.skip)?e:e.__replaceFix(b)}):a.__replaceFix(b)});return a},replaceSpace:function(){return this.cleanSpace(configs.hanSpace,/ +/g)},replaceSeparator:function(){return this.replaces(configs.rSeparator).replace(/@@@@+/g,configs.Separator).replace(/!@!@!@!@!/g,configs.tSeparator)},replaceQuotes:function(a){var b=this.replace(configs.enSep,"$1\u3014\u203b@\u203b\u3015$2").replaces(configs.rQuotes).replace(/\u3014\u203b@\u203b\u3015/g,
"'");return"cn"===a?b.replaceAt(configs.cnQuotes):b},convertESQuotes:function(a){return this.replaceAt(configs.cnQuotes,"cn"!==a)},matchUpper:function(a){return this.replace(a,function(b){return b.toUpperCase()})},matchFirstUpper:function(a){return this.replace(a,function(b){return b.toLowerCase().matchUpper(/\b[a-z]/g)})},matchLower:function(a){return this.replace(a,function(b){return b.toLowerCase()})},convertEngLine:function(){var a=configs.rEng;return this.replace(a.Line,function(b){return b.find(/^[\u201c\u300c][a-z]{1,6}(?:\u3002|[\uff01\uff1f]{1,3}|\u2026\u2026|\u2014\u2014)[\u300d\u201d]$/mi)||
2>b.findCount(a.LineSkip)||!b.find(/[,\uff0c ]/)||b.find(/[\u300a\u300b]/)?b:b.replaceAt(configs.halfPuns).replaces(configs.halfSymbol).matchLower(a.PunAfter).matchUpper(/[\.\?!:&] ?[a-z]/g).matchFirstUpper(/\([^\)]+\)/g).trim()})},convertEnglish:function(){var a=configs.rEng,b=a.Special.toLowerCase(),e=a.Unit.toLowerCase(),m="[{$enSep}]+".comReg("g"),h;return this.matchLower(/[A-Z]/g).matchUpper(/\b[a-z]/g).replace(a.Sep,function(c){return c.replace(m,"'")}).replace(a.NameSep,function(c){return c.replace(m,
"'")}).matchUpper(a.Bracket).replace(a.PunFix,function(c){return-1<c.indexOf("'")?c.matchLower(/ [A-Z]/g):c}).replace(a.Quote,function(c){return c.matchLower(/( |[a-z]{2}\uff0c)[A-Z]/g)}).replace(a.Model,function(c){return c.find(/\d/)?c.toUpperCase():c}).replace(a.Honor,function(c){return c.matchUpper(/\b[a-z]/g).replace(/\u3002/g,".")}).matchUpper(("\\b(?:"+a.Upper+")\\b").getReg("gi")).replace(("\\b("+a.Special+")(\\d{1,4}[a-z]{0,6})?\\b").getReg("gi"),function(c,g,l){h=("|"+b+"|").indexOf("|"+
g.toLowerCase()+"|")+1;return("|"+a.Special+"|").substr(h,g.length)+(l&&l.toUpperCase()||"")}).replace(("\\b(\\d[0-9\u3002.]* ?)("+a.Unit+")\\b").getReg("gi"),function(c,g,l){h=("|"+e+"|").indexOf("|"+l.toLowerCase()+"|")+1;return g+("|"+a.Unit+"|").substr(h,l.length)}).matchUpper(a.Continuou).replace(a.Suffix,function(c){return c.toLowerCase().replace(/\u3002/g,".")}).matchLower(a.Structural).matchUpper(a.Single).replace(a.NameFix,function(c){return c.slice(0,c.length-1)+c.slice(-1).toUpperCase()}).replace(a.LatinAfter,
function(c){return c.matchLower(/\b[a-zA-Z]*/g)}).matchFirstUpper(/(?:^[\u201c\u300c"']?)\b[a-zA-Z]+ /gm)},convertNumberLetter:function(a){return this.replace(/([\uff21-\uff3a][\uff41-\uff5a]+)(?=[\uff21-\uff3a][\uff41-\uff5a]+)/g,"$1 ").replaceAt(configs.sNumberLetter)},__chapterFullNumber:function(){return this.replace(configs.regFullNumberTitle,function(a){return a.replaceAt(configs.sNumber)})},convertFullNumberLetter:function(){return this.replaceAt(configs.sNumberLetter,!0).__chapterFullNumber()},
convertUnicode:function(){return this.replace(/(?:[\uff06&]#[xX]|\\[uU]?)[\da-fA-F]{4}[;\uff1b]?/g,function(a){return unescape("%u"+a.replace(/\W/g,"").replace(/^[uxUX]/,""))}).replace(/\\[xX][\da-fA-F]{2}/g,function(a){return unescape("%u00"+a.replace(/\\[xX]/,""))}).replace(/[\uff06&]#\d+[;\uff1b]/g,function(a){return String.fromCharCode(a.replace(/\D/g,""))}).replace(/(?:[%\uff05][\da-fA-F]{2})+/g,function(a){try{return decodeURIComponent(a.replace(/\uff05/g,"%"))}catch(b){return a}})},convertHtmlEntity:function(){return this.replace(configs.regHtmlEntity,
function(a){var b=a.replace(/\W/g,"");b=configs.sHtmlEntity[b]||configs.sHtmlEntity[b.toLowerCase()]||0;return 0<b?String.fromCharCode(b):a})},convertVariant:function(){return this.replaceAt(configs.sVariants)},convertSerialNumber:function(){var a=configs.sSerialNumber,b=a[1].split("|");return this.replace(("["+a[0]+"]").getReg(),function(e){return"\uff08"+(b[a[0].indexOf(e)]||"")+"\uff09"})},convertPunctuation:function(){return this.replaceAt(configs.punSymbol).replaces(configs.punSymbolFix)},setAlign:function(a,
b,e){var m=2*configs.Linenum,h=this.trims(),c=h.len();m>c&&("center"===e?h="\u3000".repeat(~~((m-c)/4))+(0===c%4?" ":"")+h:"right"===e&&(h="\u3000".repeat(~~((m-c)/2))+(0===c%2?"":" ")+h));return(a||"")+h+(b||"")},__Chapter:function(a,b,e,m){a="^{$f}[{$b.0}]?(?:{$zz})[{$b.1}]?(?:{$sn})[{$b.0}]?(?:{$e}|$)[{$b.1}]?$".fmt(a).chapReg();var h="\u3002|(?:\u5b8c|\u5b8c\u7ed3|\u5f85\u7eed|\u672a\u5b8c|\u7ec8)[{$b.1}]?$".chapReg();return this.replace(a,function(c){return-1<c.search(h)?c:c.replace("[{$b}]".chapReg("g"),
" ")}).replace(b.chapReg("gm",e),m)},__chaSkip:function(a){return this.eachArrayRegTest(configs.regSkipTitle[a||"t0"])},replaceTitle:function(a,b,e,m){a=a||"\n\n";b=b||"";var h=this,c=regChapter;m&&(c.s=c.sn,c.es=c.e);var g=function(d){return d.replaceAt(configs.sNumber).replace(/\b\d\b/,"0$&")},l=function(d,f){d=d.replace(/  +/g," ").replace("^[{$sep}]+".chapReg(),"");if(0===d.length)return"";if(d.find(/^\uff08?\d{1,3}\uff09?$/))return d.replace(/^\uff08?(\d{1,3})\uff09?$/,function(k,n){return"\uff08"+
g(n)+"\uff09"});d=d.replace(/([^\d\.])[ \u00b7]([\u4e0a\u4e2d\u4e0b\u7ec8\u5b8c]|[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e]{1,5})$/,"$1\uff08$2\uff09").replace(/ (?=[\u4E00-\u9FA5]{2,})/g,"\uff0c").replace(/ (?=[\u4E00-\u9FA5])/g,"").replace(/\u3010?\u6ce8(\d{1,2})\u3011?/g,"\u3010\u6ce8$1\u3011").replace(/([^\w\.\-\u2014])(\d{1,2}\/\d{1,2})$/,"$1\uff08$2\uff09").replace(/([^\w\.\-\u2014]) ?\b(\d{1,2})$/,"$1\uff08$2\uff09").replace(/\uff08\d{1,3}\uff09$/,function(k){return g(k)}).replace(/[ \u00b7]?\b([IVXC]{1,6})\b$/i,
function(k,n){return"\uff08"+n.toUpperCase()+"\uff09"});return checkNull(f)?configs.Divide+d:d},q="{$n4}[{$c}]".chapReg();h=h.cleanSpace("^{$f}{$ts}".chapReg()).__Chapter(c.t0,"^{$f}({$t0}){$sn}$","",function(d,f){return f.setAlign(a,b,e)}).__Chapter(c.t1.join("|"),"^{$f}({$t1})({$s}{$e}|{$sn}$)$","|",function(d,f,k){return k.find(/^[!\?\uff01\uff1f\u3002]{1,3}$/)||d.__chaSkip("t0")||d.__chaSkip("t1")?d:(f+l(k)).setAlign(a,b,e)}).__Chapter(c.t2,"^{$f}{$t2}({$sn})({$e}|$)$","",function(d,f,k,n){n=
n.trims();if(n.find(/^(?:\u5b8c|\u5b8c\u7ed3|\u5f85\u7eed|\u672a\u5b8c|\u7ec8)$/))return"\u3010"+f+"\u00b7"+n+"\u3011";if(f.find(/^[\-\u2014]{2,4}/)||d.__chaSkip("t0")||d.__chaSkip("t2")||!m&&n.find(/^[\uff01\uff1f\u3002\u2026]{1,3}$/)||!k&&!m&&n.find(/\uff0c|[\uff01\uff1f\u3002\u2026\u2019\u201d\u300f\u300d]{1,3}$/))return d;f.find(q)||(f="\u7b2c"+f.replace(/^\u7b2c+| /g,""));return(g(f)+l(n)).setAlign(a,b,e)}).__Chapter(c.t3,"^{$f}{$t3}({$e}|$)$","",function(d,f,k){return d.__chaSkip("t0")?d:(g(f)+
l(k,"no")).setAlign(a,b,e)});if("center"===e||"break"===e)return h;var p=strChapter.crt;return h.__Chapter(c.t4,"^{$f}{$t4}{$sn}({$e}|$)$","",function(d,f,k,n){return a+"\u7b2c"+k+f+l(n)+b}).__Chapter(c.t5,"^{$f}{$t5}{$sn}({$e}|$)$","",function(d,f,k){return a+"\u7b2c"+g(f)+p+l(k)+b}).__Chapter(c.t6,"^{$f}{$t6}({$s}|{$s}{$e}|$)$","",function(d,f,k){k=k.trims();f=g(f);return d.find(/\u3002/)||k.find(/^[\uff01\uff1f\u3002]{1,3}$/)||d.__chaSkip("t0")||d.__chaSkip("t2")||k.find(f.find(/^\d+/)?/[\uff01\uff1f\u3002]$/:
/[\uff01\uff1f\u3002\u2026\u2019\u201d\u300f\u300d]$/)||d.cleanSpace().__chaSkip("t6")?d:a+"\u7b2c"+f+p+l(k)+b})},replaceTitleError:function(){var a="(?:^\u7b2c{$n1}[{$crt}](?:\uff1a.{0,40}|$)$\\n+|^{$n1}(?:[\uff1a\u3001\u3002\\.\\,].{0,40}|$)$\\n+){2,}".chapReg(),b="(?:^\u7b2c{$n3}[{$crt}](?:[\uff1a].{0,40}|$)$\\n+|^{$n3}(?:[\uff1a\u3001\u3002\\.\\,].{0,40}|$)$\\n+){2,}".chapReg(),e="(?:\\n+^\uff08(?:{$n2}|{$n3})\uff09(?:.{0,40}|$)$\\n+){2,}".chapReg(),m="(^(?:{$w1}|{$w3})(?:[\uff1a\u3001\u3002\\.\\,].{0,40}|$)$\\n+)\\1".chapReg("gm"),
h="(^\uff08(?:{$w1}|{$w3})\uff09(?:.{0,40}|$)$\\n+)\\1".chapReg("gm"),c=function(g,l){return g.replace("^\u7b2c({$zz})[{$crt}](?:\uff1a|$)".fmt(l).chapReg(),"$1\u3001").replace("^({$zz})[\uff1a\u3001\u3002.,]".fmt(l).chapReg(),"$1\u3001").replace(/^0{1,4}/gm,"").replace(/\u3001$/gm,"").replace(/\n\n+/g,"\n")};return this.replace(a,function(g){return c(g,"{$n1}")}).replace(b,function(g){return c(g,"{$n3}")}).replace(e,function(g){return g.replace(/\n+/g,"\n")}).replace("\\n\\n((?:{$n1}|{$n3})\u3001?)".chapReg(),
"$1").replace(m,function(g,l){return l.replaceTitle("\n\n","")}).replace(h,function(g,l){return l.replaceTitle("\n\n","")})}});
