var vNum=config.Linenum,cutNum=2*config.Linenum;function doSplit(e,n,r){if(e.len()<1)return e+r;if(-1<e.search(/^　　+/)||-1<e.search(/^＊{5,}/))return e+r;var t="　　"+e;if(cutNum>=t.len())return t+r;for(var c=1+~~(t.length/vNum),i=[],l=t.findCount(/[\x00-\xff]/g),a=-1<t.replace(/^　　+/,"").search(/^[\x00-\xff]+$/);c--;){var o,u,p=0,g=!0;if(a)g?(p=vNum-2,g=!1):p=vNum;else if(0<l&&(o=(u=t.slice(0,vNum)).findCount(/[\x00-\xff]/g)))if(t.slice(vNum,o).len()===2*o)p=~~(o/2);else for(var $=p=Math.round(o/2);$--;)if(p++,t.slice(0,vNum+p).len()>cutNum){p--;break}u=t.slice(0,vNum+p).replace(/[［〔【｛『「〈《]{1,2}$/,function(e){return t+=e,""}),t=t.replace(u,"").replace(/^[，、。：；？！）］〕】｝』」〉》…～—]{1,2}/,function(e){return u+=e,""}),i.push(u)}return i.join("\n")+r}function onTypeSetSplit(e){return e="\n"+e.replaceInit().convertCNQuotes().replace(/作者：.*?\n[\d\/]*[发發]表[于於]：.*?\n是否首[发發]：.*?\n字[数數]：.*?\n/gm,"").convertNumberLetter().replaceSeparator().replace(("^"+config.Separator+"$").getReg("gm"),function(e){return e.setAlign("","","center")}).replace(("^[（【“「<]?(?:"+config.endStrs+")[）】”」>]?$").getReg("gm"),function(e){return e.setAlign("","","center")}).replace(config.novelTitle,function(e){return e.setAlign("","","center")}).replaceTitle("","\n","center").split("\n").map(function(e){return doSplit(e,"\n\n","\n\n")}).join("").replace(/^[ 　]+$\n/gm,"").replace(/\n\n{2,}/gm,"\n\n").replace(config.novelAuthor,function(e){return e.trim()+"\n"}).replaceEnd().replace(/\n\n{3,}/gm,"\n\n\n"),$("#Check_AddTop").is(":checked")?("简"!==$("#chinese").html()?"作者：{$w}\n{$d}发表于：{$b}\n是否首发：{$y}\n字数：{$n} 字\n":"作者：{$w}\n{$d}發表於：{$b}\n是否首發：{$y}\n字數：{$n} 字\n").fmt({w:$("#inputAuthor").val().trim()||" ",b:$("#inputSite").val().trim()||" ",y:$("#Check_0").is(":checked")?"是":"否",d:new Intl.DateTimeFormat("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date),n:(e.length-e.findCount(/[　\s]/g)).toLocaleString()})+"\n"+e:e}function onTypeSetRead(e){return e.replaceInit().convertNumberLetter().replaceTitle("\n\n","","break").replaceSeparator().replace(config.novelAuthor,"$1\n").replace(/^/gm,"　　").replace(/(^　　$\n)+/gm,"　　\n").replace(/\n{3,}/gm,"\n\n").replace(/^\n{2,}/,"\n")}function editorCleanUp(e){return e=e.replaceInit(),$("#Check_1").is(":checked")&&(e=e.convertHtmlEntity()),$("#Check_2").is(":checked")&&(e=e.convertUnicode()),$("#Check_3").is(":checked")&&(e=e.convertVariant()),$("#Check_4").is(":checked")&&(e=e.convertSerialNumber()),$("#Check_6").is(":checked")&&(e=e.convertNumberLetter()),$("#Check_7").is(":checked")&&(e=e.replaceTitle().replaceTitleError()),$("#Check_5").is(":checked")&&(e=e.convertPunctuation()),$("#Check_8").is(":checked")&&(e=e.replaceSpace()),$("#Check_9").is(":checked")&&(e=e.replaceSeparator()),$("#Check_10").is(":checked")&&(e=e.replaceQuotes()),(e=$("#Check_11").is(":checked")?e.convertEnglish():e).replaceEnd()}function editorCleanUpEx(e){var n=["\n☠","☠\n"],r=("^[\\(（【〖“「［<](?:"+config.endStrs+")[>］」”〗】）\\)]$").getReg("gm"),t=[[/([^。！？…”」\.\!\?\~\x22\x27\u2620；〗】]$)\n+([^\u2620])/gm,"$1$2"],[/^((?!第[\d一二三四五六七八九十百千]+|\u2620).+[“「][\u4E00-\u9FA5]+[”」]$)\n+/gm,"$1"],[/^([^\u2620]*[“「][^，。？！…~～\─]+[”」]$)\n+/gm,"$1"],[/，([”」])\n+/gm,"，$1"],[/…\n+…/gm,"……"],[/\n+([”」])/gm,"$1"],[/…([“「])/g,"…\n$1"],[/(.$)\n+[）\)]([^，。…！？])/gm,"$1）\n$2"],[/分卷阅读(\d+)/g,""],[n.join("|").getReg("gm"),"\n"],[/\u2620(?=第[\d一二三四五六七八九十百千]+章)/g,""],[/(第[\d一二三四五六七八九十百千]+章：)/g,"\n$1"]];return editorCleanUp(e=e.replaceInit().replaceSpace().replace(config.novelTitle,function(e){return n[0]+e+n[1]}).replace(config.novelAuthor,function(e){return n[0]+e+n[1]}).replaceTitle(n[0],n[1]).replaceQuotes().replaces(t).replace(r,""))}function setTitle(){var e=/^[（【“「<]|[）】”」>]$/g,n=$("#inputBookName").val(),r=$("#inputChapter").val(),t="";0<n.length&&(t="【"+n.trim().replace(e,"")+"】"),0<r.length&&(t+="（"+r.trim().replace(e,"")+"）"),$("#TitleMsg").html(t||$("#TitleMsg").attr("data-tip"))}